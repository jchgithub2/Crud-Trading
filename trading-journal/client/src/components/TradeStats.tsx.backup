import React from 'react';
import { Trade } from '../types/trade';

interface TradeStatsProps {
    stats: any;
    trades: Trade[];
}

const TradeStats: React.FC<TradeStatsProps> = ({ stats, trades }) => {
    console.log('TradeStats recibi√≥:', { stats, tradesLength: trades?.length });

    if (!stats || !stats.summary) {
        return (
            <div className="text-center py-12">
                <div className="text-6xl mb-4">üìä</div>
                <h3 className="text-xl font-medium text-gray-700 mb-2">Datos no disponibles</h3>
                <p className="text-gray-500">
                    {!stats ? 'Estad√≠sticas no cargadas' : 'Resumen de estad√≠sticas no disponible'}
                </p>
                <div className="mt-4 text-sm text-gray-600">
                    <p>Verifica que el backend est√© corriendo en puerto 5000</p>
                    <p>URL: <code className="bg-gray-100 px-2 py-1 rounded">http://localhost:5000/api/stats</code></p>
                </div>
            </div>
        );
    }

    const formatCurrency = (value: number | undefined) => {
        if (value === undefined || value === null) return '$0.00';
        return new Intl.NumberFormat('es-ES', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2
        }).format(value);
    };

    const formatPercentage = (value: number | undefined) => {
        if (value === undefined || value === null) return '0%';
        return `${value.toFixed(2)}%`;
    };

    // Datos seguros con valores por defecto
    const safeStats = {
        summary: {
            totalTrades: stats.summary?.totalTrades || 0,
            winningTrades: stats.summary?.winningTrades || 0,
            losingTrades: stats.summary?.losingTrades || 0,
            winRate: stats.summary?.winRate || 0,
            totalPnL: stats.summary?.totalPnL || 0,
            avgWin: stats.summary?.avgWin || 0,
            avgLoss: stats.summary?.avgLoss || 0,
            profitFactor: stats.summary?.profitFactor || 0
        },
        performance: {
            bestTrade: stats.performance?.bestTrade || 0,
            worstTrade: stats.performance?.worstTrade || 0,
            largestWin: stats.performance?.largestWin || 0,
            largestLoss: stats.performance?.largestLoss || 0
        },
        bySymbol: stats.bySymbol || {}
    };

    const safeTrades = trades || [];

    // Calcular maxPnl de forma segura
    const maxPnl = safeTrades.length > 0
        ? Math.max(...safeTrades.map(t => Math.abs(t.pnl || 0)))
        : 1;

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                <h2 className="text-2xl font-bold mb-2">üìà Estad√≠sticas de Rendimiento</h2>
                <p className="text-blue-100">An√°lisis detallado de tu desempe√±o en trading</p>
                <p className="text-blue-200 text-sm mt-2">
                    Operaciones: {safeStats.summary.totalTrades} | P&L Total: {formatCurrency(safeStats.summary.totalPnL)}
                </p>
            </div>

            {/* Resumen Principal */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Tarjeta de Resumen */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-xl font-bold text-gray-800 mb-6">üìä Resumen General</h3>
                    <div className="space-y-4">
                        <div className="flex justify-between items-center pb-3 border-b">
                            <span className="text-gray-600">Total Operaciones</span>
                            <span className="font-bold text-lg">{safeStats.summary.totalTrades}</span>
                        </div>
                        <div className="flex justify-between items-center pb-3 border-b">
                            <span className="text-gray-600">Operaciones Ganadoras</span>
                            <span className="font-bold text-lg text-green-600">{safeStats.summary.winningTrades}</span>
                        </div>
                        <div className="flex justify-between items-center pb-3 border-b">
                            <span className="text-gray-600">Operaciones Perdedoras</span>
                            <span className="font-bold text-lg text-red-600">{safeStats.summary.losingTrades}</span>
                        </div>
                        <div className="flex justify-between items-center pb-3 border-b">
                            <span className="text-gray-600">Win Rate</span>
                            <span className="font-bold text-lg text-purple-600">
                                {formatPercentage(safeStats.summary.winRate)}
                            </span>
                        </div>
                        <div className="flex justify-between items-center pb-3 border-b">
                            <span className="text-gray-600">P&L Total</span>
                            <span className={`font-bold text-lg ${safeStats.summary.totalPnL >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {formatCurrency(safeStats.summary.totalPnL)}
                            </span>
                        </div>
                        <div className="flex justify-between items-center pb-3 border-b">
                            <span className="text-gray-600">Ganancia Promedio</span>
                            <span className="font-bold text-lg text-green-600">
                                {formatCurrency(safeStats.summary.avgWin)}
                            </span>
                        </div>
                        <div className="flex justify-between items-center pb-3 border-b">
                            <span className="text-gray-600">P√©rdida Promedio</span>
                            <span className="font-bold text-lg text-red-600">
                                {formatCurrency(safeStats.summary.avgLoss)}
                            </span>
                        </div>
                        <div className="flex justify-between items-center">
                            <span className="text-gray-600">Profit Factor</span>
                            <span className="font-bold text-lg text-blue-600">
                                {safeStats.summary.profitFactor.toFixed(2)}
                            </span>
                        </div>
                    </div>
                </div>

                {/* Tarjeta de Performance */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-xl font-bold text-gray-800 mb-6">‚ö° Performance</h3>
                    <div className="space-y-4">
                        <div className="bg-green-50 p-4 rounded-lg">
                            <div className="text-sm text-green-600 font-medium">Mejor Operaci√≥n</div>
                            <div className="text-2xl font-bold text-green-700">
                                {formatCurrency(safeStats.performance.bestTrade)}
                            </div>
                            <div className="text-sm text-green-600 mt-1">Ganancia m√°s alta</div>
                        </div>
                        <div className="bg-red-50 p-4 rounded-lg">
                            <div className="text-sm text-red-600 font-medium">Peor Operaci√≥n</div>
                            <div className="text-2xl font-bold text-red-700">
                                {formatCurrency(safeStats.performance.worstTrade)}
                            </div>
                            <div className="text-sm text-red-600 mt-1">P√©rdida m√°s baja</div>
                        </div>
                        <div className="bg-blue-50 p-4 rounded-lg">
                            <div className="text-sm text-blue-600 font-medium">Ganancia M√°s Grande</div>
                            <div className="text-2xl font-bold text-blue-700">
                                {formatCurrency(safeStats.performance.largestWin)}
                            </div>
                            <div className="text-sm text-blue-600 mt-1">M√°xima ganancia individual</div>
                        </div>
                        <div className="bg-orange-50 p-4 rounded-lg">
                            <div className="text-sm text-orange-600 font-medium">P√©rdida M√°s Grande</div>
                            <div className="text-2xl font-bold text-orange-700">
                                {formatCurrency(safeStats.performance.largestLoss)}
                            </div>
                            <div className="text-sm text-orange-600 mt-1">M√°xima p√©rdida individual</div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Gr√°fico de Barras Simple para P&L por Operaci√≥n */}
            {safeTrades.length > 0 && (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-xl font-bold text-gray-800 mb-6">üìä Distribuci√≥n de P&L por Operaci√≥n</h3>
                    <div className="flex items-end h-64 space-x-1 overflow-x-auto">
                        {safeTrades.slice(0, 15).map((trade, index) => {
                            const height = trade.pnl !== 0 ? (Math.abs(trade.pnl) / maxPnl) * 200 : 5;

                            return (
                                <div key={trade.id || index} className="flex flex-col items-center flex-1 min-w-[50px]">
                                    <div
                                        className={`w-3/4 rounded-t ${trade.pnl >= 0 ? 'bg-green-500' : 'bg-red-500'}`}
                                        style={{ height: `${height}px` }}
                                    ></div>
                                    <div className="text-xs text-gray-600 mt-2 text-center truncate w-full">
                                        {trade.symbol || `Op ${index + 1}`}
                                    </div>
                                    <div className={`text-xs font-medium mt-1 ${trade.pnl >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        ${trade.pnl > 0 ? '+' : ''}{trade.pnl.toFixed(0)}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="flex justify-between text-sm text-gray-500 mt-4">
                        <span>‚Üê Operaciones m√°s recientes</span>
                        <span>Total: {safeTrades.length} operaciones</span>
                    </div>
                </div>
            )}

            {/* Estad√≠sticas por S√≠mbolo */}
            {safeStats.bySymbol && Object.keys(safeStats.bySymbol).length > 0 && (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-xl font-bold text-gray-800 mb-6">üéØ Desempe√±o por Activo</h3>
                    <div className="overflow-x-auto">
                        <table className="w-full">
                            <thead>
                                <tr className="border-b">
                                    <th className="text-left py-3 text-gray-600 font-medium">Activo</th>
                                    <th className="text-left py-3 text-gray-600 font-medium">Operaciones</th>
                                    <th className="text-left py-3 text-gray-600 font-medium">Ganadoras</th>
                                    <th className="text-left py-3 text-gray-600 font-medium">P&L Total</th>
                                    <th className="text-left py-3 text-gray-600 font-medium">Win Rate</th>
                                    <th className="text-left py-3 text-gray-600 font-medium">Avg P&L</th>
                                </tr>
                            </thead>
                            <tbody>
                                {Object.entries(safeStats.bySymbol).map(([symbol, data]: [string, any]) => {
                                    const safeData = data || { trades: 0, wins: 0, pnl: 0 };
                                    const winRate = safeData.trades > 0 ? (safeData.wins / safeData.trades) * 100 : 0;
                                    const avgPnL = safeData.trades > 0 ? safeData.pnl / safeData.trades : 0;

                                    return (
                                        <tr key={symbol} className="border-b hover:bg-gray-50">
                                            <td className="py-3 font-medium">{symbol}</td>
                                            <td className="py-3">{safeData.trades}</td>
                                            <td className="py-3 text-green-600">{safeData.wins}</td>
                                            <td className={`py-3 font-medium ${safeData.pnl >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                {formatCurrency(safeData.pnl)}
                                            </td>
                                            <td className="py-3">
                                                <div className="flex items-center">
                                                    <span className="mr-2">{winRate.toFixed(1)}%</span>
                                                    <div className="w-24 bg-gray-200 rounded-full h-2">
                                                        <div
                                                            className="bg-purple-600 h-2 rounded-full"
                                                            style={{ width: `${Math.min(winRate, 100)}%` }}
                                                        ></div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className={`py-3 font-medium ${avgPnL >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                {formatCurrency(avgPnL)}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* An√°lisis de Consistencia */}
            {safeTrades.length > 0 && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-6">üìÖ Consistencia Mensual</h3>
                        <div className="space-y-3">
                            {(() => {
                                const monthlyData = safeTrades.reduce((acc: any, trade) => {
                                    const date = new Date(trade.entryDate || new Date());
                                    const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;

                                    if (!acc[monthYear]) {
                                        acc[monthYear] = { pnl: 0, trades: 0, wins: 0 };
                                    }
                                    acc[monthYear].pnl += trade.pnl || 0;
                                    acc[monthYear].trades += 1;
                                    if ((trade.pnl || 0) > 0) acc[monthYear].wins += 1;

                                    return acc;
                                }, {});

                                return Object.entries(monthlyData)
                                    .sort(([a], [b]) => b.localeCompare(a))
                                    .slice(0, 6)
                                    .map(([month, data]: [string, any]) => (
                                        <div key={month} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <div>
                                                <div className="font-medium">{month}</div>
                                                <div className="text-sm text-gray-500">{data.trades} operaciones</div>
                                            </div>
                                            <div className="text-right">
                                                <div className={`font-bold ${data.pnl >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {formatCurrency(data.pnl)}
                                                </div>
                                                <div className="text-sm text-gray-500">
                                                    Win rate: {data.trades > 0 ? ((data.wins / data.trades) * 100).toFixed(1) : '0.0'}%
                                                </div>
                                            </div>
                                        </div>
                                    ));
                            })()}
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-6">üìã M√©tricas de Calidad</h3>
                        <div className="space-y-4">
                            <div>
                                <div className="flex justify-between mb-1">
                                    <span className="text-gray-600">Risk/Reward Ratio</span>
                                    <span className="font-medium">
                                        {safeStats.summary.avgLoss !== 0
                                            ? (Math.abs(safeStats.summary.avgWin) / Math.abs(safeStats.summary.avgLoss)).toFixed(2)
                                            : '‚àû'}
                                    </span>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-2">
                                    <div
                                        className="bg-blue-600 h-2 rounded-full"
                                        style={{
                                            width: `${Math.min(
                                                (Math.abs(safeStats.summary.avgWin) / Math.abs(safeStats.summary.avgLoss || 1)) * 10,
                                                100
                                            )}%`
                                        }}
                                    ></div>
                                </div>
                            </div>

                            <div>
                                <div className="flex justify-between mb-1">
                                    <span className="text-gray-600">Expectativa Matem√°tica</span>
                                    <span className={`font-medium ${(safeStats.summary.winRate / 100) * safeStats.summary.avgWin +
                                        ((100 - safeStats.summary.winRate) / 100) * safeStats.summary.avgLoss >= 0
                                        ? 'text-green-600'
                                        : 'text-red-600'
                                        }`}>
                                        {formatCurrency(
                                            (safeStats.summary.winRate / 100) * safeStats.summary.avgWin +
                                            ((100 - safeStats.summary.winRate) / 100) * safeStats.summary.avgLoss
                                        )}
                                    </span>
                                </div>
                                <div className="text-sm text-gray-500">
                                    Ganancia esperada por operaci√≥n
                                </div>
                            </div>

                            <div>
                                <div className="flex justify-between mb-1">
                                    <span className="text-gray-600">Sharpe Ratio (simplificado)</span>
                                    <span className="font-medium">
                                        {(() => {
                                            const returns = safeTrades.map(t => t.pnl || 0);
                                            if (returns.length === 0) return '0.00';
                                            const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
                                            const stdDev = Math.sqrt(
                                                returns.reduce((sq, n) => sq + Math.pow(n - avgReturn, 2), 0) / returns.length
                                            );
                                            return stdDev !== 0 ? (avgReturn / stdDev).toFixed(2) : '0.00';
                                        })()}
                                    </span>
                                </div>
                                <div className="text-sm text-gray-500">
                                    Rentabilidad ajustada al riesgo
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Consejos basados en estad√≠sticas */}
            <div className="bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-xl p-6">
                <h3 className="text-xl font-bold text-gray-800 mb-6">üí° Insights y Recomendaciones</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="bg-white p-4 rounded-lg shadow-sm">
                        <div className="text-lg font-medium text-blue-600 mb-2">üéØ Estrategia</div>
                        <p className="text-gray-600">
                            {safeStats.summary.winRate > 70
                                ? "Excelente win rate! Tu estrategia de entrada es muy efectiva."
                                : safeStats.summary.winRate > 50
                                    ? "Win rate positivo. Enf√≥cate en mejorar tu risk/reward ratio."
                                    : "Win rate bajo. Revisa tus criterios de entrada y considera ser m√°s selectivo."}
                        </p>
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow-sm">
                        <div className="text-lg font-medium text-green-600 mb-2">üí∞ Gesti√≥n de Riesgo</div>
                        <p className="text-gray-600">
                            {safeStats.summary.profitFactor > 2
                                ? "Excelente profit factor! Tu gesti√≥n de ganancias/p√©rdidas es √≥ptima."
                                : safeStats.summary.profitFactor > 1.5
                                    ? "Profit factor aceptable. Podr√≠as mejorar cortando p√©rdidas antes o dejando correr ganancias."
                                    : "Profit factor bajo. Considera revisar tus stops y toma de beneficios."}
                        </p>
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow-sm">
                        <div className="text-lg font-medium text-purple-600 mb-2">üìä Siguientes Pasos</div>
                        <p className="text-gray-600">
                            {safeStats.bySymbol && Object.keys(safeStats.bySymbol).length < 3
                                ? "Considera diversificar en m√°s activos para reducir riesgo espec√≠fico."
                                : "Analiza tus operaciones ganadoras para identificar patrones exitosos y replicarlos."}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default TradeStats;